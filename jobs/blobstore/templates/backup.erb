#!/usr/bin/env bash

set -ex

BOSH_DATA_DIRECTORY=${BOSH_DATA_DIRECTORY:-/var/vcap/store}

<%
  dir_mapping = {
    "droplets" => "cc.droplets.droplet_directory_key",
    "buildpacks" => "cc.buildpacks.buildpack_directory_key",
    "packages" => "cc.packages.app_package_directory_key"
  }
  blobstore_directories = link('blobstore_directories')
%>
<% if p('release_level_backup') %>
    mkdir -p $BBR_ARTIFACT_DIRECTORY/shared
  <% p('directories_to_backup').each do |directory| %>
    <% key = blobstore_directories.p(dir_mapping[directory]) %>
      if [ -d $BOSH_DATA_DIRECTORY/shared/<%= key %> ]; then
        cp --recursive --link $BOSH_DATA_DIRECTORY/shared/<%= key %> $BBR_ARTIFACT_DIRECTORY/shared
      fi

    <% if directory.eql? "droplets" %>
      rm --force --recursive $BBR_ARTIFACT_DIRECTORY/shared/<%= key %>/buildpack_cache
    <% end %>
  <% end %>
<% end %>
